# 小学数学应用题自动解题系统改进实验报告

## 1. 引言

本实验针对小学数学应用题自动解题问题，采用“数据构建”(方案2)对基线系统进行改进。数学应用题解决是评估AI阅读理解与推理能力的重要场景，同时在K12教育领域具有广泛应用价值。

基线系统直接使用Qwen2.5-0.5B-Instruct模型进行微调，正确率仅为0.1385，存在显著提升空间。

本实验使用高级大语言模型生成思维链(Chain-of-Thought, CoT)，用来增强训练数据集，成功将正确率提升至0.2361，提升了71%。

## 2. 问题分析

### 2.1 基线系统的不足

分析基线系统的预测结果，发现存在以下主要问题：

* **缺乏推理过程**：模型直接输出数字答案，没有中间思考步骤
* **难以处理多步骤计算**：复杂问题需要分步骤推理，直接预测容易出错
* **训练数据格式过于简单**：原始数据中的答案仅为纯数字，未包含推理过程

### 2.2 思维链方法的优势

思维链(CoT)方法允许模型通过显式的推理步骤解决问题，特别适合数学问题求解：

* 使模型模拟人类解题过程，逐步推理
* 通过中间步骤分解复杂问题
* 提高解题过程的可解释性和可靠性

## 3. 方法实现

### 3.1 数据增强与思维链构建

我们采用“知识蒸馏”的思路，使用高级大语言模型生成包含详细解题步骤的思维链：

1. **选择大模型**：使用GPT-4o-mini和GPT-4.1-nano为训练集生成思维链
2. **设计提示词**：为大模型提供明确指令，生成清晰的解题步骤和正确答案
3. **并行处理**：使用ThreadPoolExecutor实现并行请求，大幅提高数据处理速度
4. **格式规范化**：确保生成的思维链末尾包含“答案：\[数字]”格式，并在最后一行单独保留纯数字
5. **思维链长度控制**：在Prompt中加入“最多4步、每步一句话、整体不超过200 token”限制，并在生成后对Token数再次截断，确保每条CoT不超过200 token，从而在保证逻辑完整性的同时控制训练与推理的速度。

示例增强前数据：

```json
{
  "id": "0",
  "question": "食堂运来105千克的萝卜，运来的青菜是萝卜的3倍，运来青菜多少千克？",
  "answer": "315",
  "instruction": "这是小学数学1-6年级的校内题目，无需进行分析，请直接输出数字答案，不带单位。"
}
```

示例增强后数据：

```json
{
  "id": "0",
  "question": "食堂运来105千克的萝卜，运来的青菜是萝卜的3倍，运来青菜多少千克？",
  "answer": "1. 已知：萝卜105千克，青菜是萝卜3倍\n2. 公式：青菜=105×3\n3. 计算：105×3=315\n答案：315",
  "instruction": "请解答以下数学题，先给出必要的解题步骤，最后一行只写一个数字作为最终答案，不要包含任何其他文字、标点或单位。"
}
```

### 3.2 模型训练调整

为适应包含思维链的长文本，对原有训练流程进行了以下调整：

1. **增加最大序列长度**：将MAX\_LENGTH从384增加至512，以容纳Instruction+Question+200 token的CoT
2. **修改训练指令**：更新instruction字段，指导模型生成规范格式的解题过程
3. **后处理截断**：在`process_func`中对answer部分再限长200 token，防止偶发超长
4. **优化模型保存策略**：每1000步保存一次检查点，保留最终模型(checkpoint-3750)

### 3.3 推理阶段优化

为从生成的思维链中准确提取数字答案，开发了专门的后处理逻辑：

1. **答案提取函数**：从模型输出中提取最终数字答案
2. **多级备份策略**：

   * 首先尝试提取最后一行纯数字
   * 然后匹配“答案：数字”格式
   * 最后提取文本中最后出现的数字
3. **支持多种数值格式**：使用正则表达式支持整数、小数、分数和百分数

```python
def extract_final_answer(response):
    # 按行分割取最后一行
    lines = [line.strip() for line in response.strip().split('\n') if line.strip()]
    if lines:
        last_line = lines[-1]
        # 提取数字（支持分数、小数、百分数等）
        numbers = re.findall(r'[-+]?\d*\.?\d+(?:/\d+)?%?', last_line)
        if numbers:
            return numbers[0]
    # 备用提取方法
    match = re.search(r'答案[:：]\s*([-+]?\d*\.?\d+(?:/\d+)?%?)', response)
    if match:
        return match.group(1)
    # 最后备选方法
    numbers = re.findall(r'[-+]?\d*\.?\d+(?:/\d+)?%?', response)
    if numbers:
        return numbers[-1]
    return "0"
```

## 4. 实验设置

### 4.1 数据集

* **训练集**：12000条小学数学应用题，每条包含问题和答案
* **测试集**：8000条小学数学应用题
* **增强方式**：为每道题生成包含精炼思维链（≤200token）的解题步骤

### 4.2 模型配置

* **基础模型**：Qwen2.5-0.5B-Instruct
* **微调方法**：LoRA (Low-Rank Adaptation)
* **LoRA参数**：

  * r = 8
  * lora\_alpha = 32
  * lora\_dropout = 0.1
  * target\_modules = \["q\_proj", "k\_proj", "v\_proj", "o\_proj", "gate\_proj", "up\_proj", "down\_proj"]

### 4.3 训练参数

* **批次大小**：4 × 4(梯度累积) = 16
* **学习率**：1e-4
* **训练轮数**：5轮
* **最大序列长度**：512

## 5. 实验结果

### 5.1 性能对比

| 系统      | 正确率    | 相对提升 |
| ------- | ------ | ---- |
| 基线系统    | 0.1385 | -    |
| CoT增强系统 | 0.2361 | +71% |

### 5.2 推理速度对比

* **详细CoT（原始500+token）**：≈30s/it
* **精炼CoT（≤200 token）**：≈4s/it

### 5.3 问题类型分析

思维链方法在以下类型问题上表现出明显优势：

* **多步骤计算问题**：如分数计算、单位换算等
* **逻辑推理问题**：如行程问题、工程问题等
* **需要方程求解的问题**：如设未知数解方程

## 6. 讨论

### 6.1 性能提升分析

思维链方法显著提高了模型的小学数学应用题解决能力，主要原因有：

1. **结构化思考过程**：通过逐步分析，模型学会了分解复杂问题
2. **知识蒸馏效应**：大模型的解题知识被有效迁移到小模型中
3. **格式一致性**：标准化的答案格式有助于模型理解输出要求

### 6.2 局限性

实验中也发现了一些局限性：

1. **推理速度下降**：从基线系统的6样本/秒降低至约0.25样本/秒（4s/it）
2. **计算复杂度增加**：由于Transformer的O(n²)复杂度，生成长文本增加计算量
3. **截断风险**：少数复杂问题的思路可能被截断，影响结果准确性

### 6.3 速度与准确率权衡

思维链方法在提高准确率的同时，显著降低了推理速度。这是一个经典的性能-速度权衡问题：

* 简单输出数字答案：速度快（<0.2s/it）、准确率低
* 精炼思维链（≤200token）+只输出答案：速度适中（≈4s/it）、准确率高

## 7. 结论与展望

本实验证明了精炼CoT方法在提升小模型数学问题解决能力方面的有效性，将Qwen2.5-0.5B-Instruct模型的正确率从0.1385提升至0.2361，相对提升了71%，并将推理速度优化至4s/it。未来可进一步结合动态截断和模型量化，以实现更优的准确率-速度平衡。
